"use strict";var exports={};browsers.define("usermenu",["jquery","utils","musicsig","config"],function(a,b,c,d){var e,f,g,h=document.getElementById("side_bar_inner")||document.getElementById("side_bar"),i=h&&"quick_login"!==h.firstElementChild.id&&h.firstElementChild,j=0,k={parseJsonFriends:function(a){for(var b=[],c=0;c<a.length;c++)b[c]='<a href="/'+(a[c][4]?a[c][4]:"id"+a[c][0])+'"><img src="'+a[c][2]+'"/> '+a[c][1]+"</a>";return b},menuEx:function(a,b,c,d){browsers.ajax(a,{method:b?"POST":"GET",data:b,success:function(a){var b="";if("{"===a[0]?(a=JSON.parse(a),a.html?b=a.html.match(c):a.friends&&(b=k.parseJsonFriends(a.friends))):b=a.match(c),b){var e={};b.forEach(function(a){var b=c.exec(a);b&&(e[b[1]]=b[2]),c.exec(a)}),d(e)}}})},createMenuFromLinks:function(a){var b=document.createElement("ol");for(var c in a)a.hasOwnProperty(c)&&k.addMenuItem(b,"li",a[c],c);return b},hideUserMenu:function(){f&&f.hide(),j&&(clearTimeout(j),j=null)},prepUserMenu:function(b){k.hideUserMenu(),f&&(f.off("mouseout").attr("class","vkmenu").css({position:"absolute","z-index":100,top:"",left:""}),a(b.target).after(f))},showUserMenu:function(a){f&&(f.text(""),a?f.append(k.getUserLinks(a)):f.append(c.$c("ol",{kids:{0:c.$c("li",{"#text":c.lang("iderror")})}})),f.mouseout(function(){j&&clearTimeout(j),j=setTimeout(function(){k.hideUserMenu()},300)}).css({display:"inline-block","margin-left":"-8px"}))},addMenuToUserLinks:function(b){if(b=b||window.page_body||window.pageBody){var d,e=a("a.author:not(.menu), a.published_by:not(.menu)"),f=function(b){k.prepUserMenu(b),k.showUserMenu(a(this).data("userId"))},g=a("#myprofile_wrap a").attr("href");e.each(function(b,e){var h=a(e);if(h.addClass("menu"),d=""+(h.data("from-id")||h.data("post-id")&&h.data("post-id").split("_")[0]),d&&"-"!==d.charAt(0)&&g!==h.attr("href")){var i=c.$c("a",{"class":"userLink","#html":"&blacktriangledown;"});a(i).data("userId",d).mouseover(f),h.after(i)}})}},getMenuItems:function(d){var e=null,g="";"albums"===d.substr(0,6)?(g=d,d="photos"):"im"===d&&(d="mail");var h=/<div\s+class="group_row_labeled"><a\s+href="([^"]+)"><b>([^<]+)<\/b><\/a><\/div>/g,i=/<div\s+class="fl_l\s+groups_row_inv_info">\s+<a\s+href="([^"]+)"><b>([^<]+)<\/b><\/a>/g,j=/<div\s+class="friends_field"><a\s+href="([^"]+)"><b>([^<]+)<\/b><\/a><\/div>/g,l=/<a\s+href="([^"]+)"\s+ontouchstart="event\.cancelBubble\s*=\s*true;".*class="[^"]+">\s*<img src="[^"]+"\/>(?:\s*<div[^>]*>\s*<div[^>]*>\s*<\/div>\s*<div[^>]*>\s*<\/div>\s*<\/div>)?\s*<div[^>]*>\s*<div[^>]*>\s*<div\s+class="ge_photos_album\s+fl_l"\s+title="([^"]+)">/gm,m=/<div\s+class="app_cat_name\s+sl_nowrap">\s*<a\s+href="([^"]+)"[^>]*>([^<]+)<\/a>\s*<\/div>/gm;switch(d){case"pedit":e={mPMain:"/edit",mPContacts:"/edit?act=contacts",mPAddress:"/editProfile.php?act=addresses",mPEducation:"/editProfile.php?act=education",mPCareer:"/editProfile.php?act=career",mPMilitary:"/editProfile.php?act=military",mPPersonal:"/edit?act=personal"};break;case"friends":case"fr":e={mFAll:"/friends?section=all",mFOnline:["/friends?section=online",!0,j],mFRecent:["/friends?section=recent",!0,j],mFPBook:"/friends?section=phonebook",mFRequests:"/friends?section=requests"};break;case"photos":case"ph":e={mPAll:["/albums"+k.userID,!0,l],mPUser:"/tag"+k.userID+"?albums=1",mPComments:"/photos"+k.userID+"?act=comments",mPAlbums:"/photos"+k.userID,mPFriends:"/friendsphotos"};break;case"video":case"vid":e={mVAll:"/video",mVTagview:"/video?section=tagged",mVComments:"/video?section=comments"};break;case"audio":case"aud":e={mAAll:"/audio",mAEdit:"/audio?act=edit"};break;case"notes":e={mNAll:"/notes",mNAdd:"/notes?act=new",mPComments:"/notes?act=comments",mNFriends:"/notes?section=friends",mNFave:"/notes?section=fave"};break;case"groups":case"gr":e={mGAll:["/groups",!0,h],mGInvite:["/groups?filter=invitations",!0,i],mGNews:"/feed?section=groups",mGSearch:"/search?c[section]=communities"};break;case"feed":case"newsfeed":case"nwsf":e={mNStatuses:"/feed",mNfFriends:"/feed?section=friends",mNGroups:"/feed?section=groups",mPComments:"/feed?section=comments",mNComments:"/photos.php?act=comments",mNCommentsWMe:"/photos.php?act=comments&user=1"};break;case"settings":e={mSMain:"/settings",mSPrivacy:"/settings?act=privacy",mSNotify:"/settings?act=notify",mSBlacklist:"/settings?act=blacklist",mSMobile:"/settings?act=mobile",mSBalance:"/settings?act=balance",MusicSig:"/settings?act=musicsig"};break;case"matches":e={mMAll:"/matches.php",mMSearch:"/matches.php?act=search",mMAccepted:"/matches.php?act=sent"};break;case"opinions":e={mOAll:"/opinions.php",mOOutbox:"/opinions.php?act=outbox",mOFriends:"/opinions.php?act=friends"};break;case"apps":case"ap":e={mApMy:["/apps?act=apps",!0,m],mApAll:"/apps?act=catalog",mApDel:"javascript:Ajax.Send('apps.php?act=a_delete_all_not',{},function(){alert('Ok!');});",mApSettings:"/apps?act=settings"};break;case"questions":e={mQAll:"/questions.php",mQAdd:"/questions.php?act=add_question",mQSearch:"/questions.php?act=all",mQFriends:"/questions.php?act=friends",mQAnswered:"/questions.php?act=answered"};break;case"market":e={mMaAll:"/market.php",mMaMy:"/market.php?show=my",mMaFriends:"/market.php?show=friends"};break;case"ads":e={mAdAll:"/ads.php?act=list",mAdAdd:"/ads.php?act=create"};break;case"gifts":e={mGifts:"/gifts.php",mWishs:"/gifts.php?act=wishlist",mWishsDone:"/gifts.php?act=wishlist&done=1",mWishsFriends:"/gifts.php?act=wishlist&mid=-1"};break;case"fave":e={peoples:["/fave",!0,/<a href=["']\/(.+)['"]>([^<]+)<small>([^<]+)<\/small><\/a>/g],groups:["/fave",!0,/<a href=.\/club(\d+)\?f=1.>([^<]+)<\/a>/g]}}if(e){var n=c.$c("ol"),o=function(){var b=a(this);b.off("mouseover");var c=b.data("url"),d=!0,e=b.data("re");if(d===!0){var g=c.split("?");g||(g=[c,""]),k.menuEx(g[0].substr(1),g[1],e,function(a){f.empty().append(k.createMenuFromLinks(a))})}};for(var p in e)if(p&&e.hasOwnProperty(p)){var q=b.isArray(e[p]),r=c.$c("a",{href:q?e[p][0]:e[p],"#text":c.lang(p)}),s=c.$c("div",{kids:{0:r}}),t=c.$c("li",{kids:{0:s}});if(q){var u=c.$c("span",{"#html":"&blacktriangleright;"});a(u).data("url",e[p][0]).data("re",e[p][2]).mouseover(o).appendTo(s)}n.appendChild(t)}return n}return!1},addUserToBlackList:function(b,d){return k.hideUserMenu(),g||(g=a("#logout_link").attr("href").match(/hash=([\w\d]+)/)[1]),g?browsers.ajax("al_settings.php",{method:"POST",data:{act:"search_blacklist",query:"https://vk.com/id"+b,al:1,hash:g},success:function(a){a.match('<div id="error">')?alert(c.lang("blAddFalse")):alert(c.lang("blAddTrue"))}}):d||browsers.ajax("settings.php?act=blacklist",{success:function(a){var d=a.match(/id=.hash. value=.([a-z0-9]+)./);d?(g=d[1],k.addUserToBlackList(b,!0)):alert(c.lang("blAddFalse"))}}),!1},getUserLinks:function(a){var b={mMNew:"/write",pmPhotoWith:"/tag",pmVideoWith:"/video?section=tagged&id=",photos:"/photos.php?id=",audio:"/audio?friend=",videos:"/videos",mmWall:"/wall",notes:"/notes.php?id=",pmGifts:"/gifts"},d=c.$c("ol",{});for(var e in b)d.appendChild(c.$c("li",{kids:{0:c.$c("a",{href:b[e]+a,"#text":c.lang(e)})}}));return d},userID:"",addSideMenuSubItems:function(){if(!i)return!1;a(i).find('a[href^="/audios"]').each(function(b,c){k.userID=a(c).attr("href").replace(/^\/audios/,"")}),a(i).find("li .left_label").mouseover(function(b){var e,g;if(b&&b.target){var i=a(b.target);if(e=i.parent().parent().attr("id")||i.parent().parent().parent().attr("id"),e&&(g=k.getMenuItems(e.substr(2)),k.hideUserMenu(),g)){f.text(""),f.attr("class","vkmenu");var j=c.is2016DesignLayout()?240:118,l=h.offsetLeft>0?j:h.offsetLeft+j;d.lockMenu&&(l+=h.offsetLeft),f.css({position:"absolute","z-index":"300",left:c.is2016DesignLayout()?"155px":"132px",top:"-5px","float":"left"}).append(g).insertAfter(i).show()}}}).mouseout(function(a){a.stopPropagation(),f.mouseout()});for(var b,e=c.geTN(i,"li"),g=e.length-1;g>=0;g--){var j=c.geTN(e[g],"a");j[1]?b="pedit":j[0]&&j[0].href&&(b=j[0].href.split("/")[3],"fave"===b&&d.whoBookMMe&&(b="fave.php",j[0].href="/fave.php",j[0].setAttribute("onclick","")),b&&(b=b.split(".")[0])),b&&(e[g].childNodes[0].id="mm"+b)}},addMenuItem:function(a,b,d,e,f,g){if(a=a||i){var j=c.$c(b,{kids:{0:c.$c("a",{href:e,"class":"left_row",kids:{0:c.$c("span",{"class":"left_label inl_bl","#text":d})}})}});j.id=g,-1===f?a.appendChild(j):a.insertBefore(j,c.geByClass(h?"more_div":"moreDiv",a)[f])}},hideMyFromMenu:function(){if(i)for(var b=a("a span.left_label",i),c=0;c<b.length;c++){var d=b[c].textContent.indexOf(" ");d>-1&&4>d&&(b[c].textContent=b[c].textContent.substring(d))}},initExtendedUserMenu:function(){h&&(e||(e=c.$c("div",{id:"exusm","class":"vkmenu"}),f=a(e),h.appendChild(e)),f&&f.mouseover(function(){j&&clearTimeout(j),j=0}).mouseout(function(a){a.stopPropagation(),j&&clearTimeout(j),j=setTimeout(k.hideUserMenu,300)}))}};return k},exports);